---
phase: 02-interactive-content
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - frontend/src/components/video/VideoQuizOverlay.tsx
  - frontend/src/components/video/VideoQuizTriggerManager.tsx
  - frontend/src/hooks/useVideoQuiz.ts
  - frontend/src/components/video/index.ts
  - frontend/src/components/video/InteractiveVideoPlayer.tsx
autonomous: true

must_haves:
  truths:
    - "Quiz appears when video reaches trigger timestamp"
    - "Video pauses automatically when quiz triggers"
    - "User must answer required quizzes to continue"
    - "User can skip optional quizzes"
    - "Video resumes after quiz is completed or skipped"
  artifacts:
    - path: "frontend/src/components/video/VideoQuizOverlay.tsx"
      provides: "Quiz display overlay on video"
      min_lines: 80
    - path: "frontend/src/hooks/useVideoQuiz.ts"
      provides: "Quiz trigger detection and state management"
      min_lines: 40
  key_links:
    - from: "useVideoQuiz.ts"
      to: "InteractiveVideoPlayer"
      via: "currentTime comparison with triggers"
      pattern: "quizTriggers.*find|filter"
    - from: "VideoQuizOverlay.tsx"
      to: "quiz completion"
      via: "onComplete callback"
      pattern: "onComplete|onSkip"
---

<objective>
Add in-video quiz functionality with pause-and-answer behavior.

Purpose: Transform passive video watching into active learning with comprehension checks at key moments.
Output: VideoQuizOverlay that triggers at specified timestamps, pauses video, and requires interaction before continuing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Patterns to follow
@.planning/codebase/CONVENTIONS.md

# Prior work this depends on
@.planning/phases/02-interactive-content/02-01-SUMMARY.md

# Existing quiz components for reference
@frontend/src/components/learning/course-player/QuizQuestion.tsx
@frontend/src/components/learning/course-player/ModuleQuiz.tsx
@frontend/src/types/course.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useVideoQuiz hook for quiz trigger detection</name>
  <files>frontend/src/hooks/useVideoQuiz.ts</files>
  <action>
    Create `frontend/src/hooks/useVideoQuiz.ts`:

    Input:
    - currentTime: number (video current time in seconds)
    - quizTriggers: VideoQuizTrigger[] (from video.ts types)
    - answeredQuizzes: Set<string> (quiz IDs already answered)

    Return:
    - activeQuiz: VideoQuizTrigger | null (quiz that should be shown)
    - shouldPause: boolean (video should pause for this quiz)
    - hasUnansweredRequired: boolean (can user skip ahead)
    - markAnswered: (quizId: string) => void

    Logic:
    - Find first unanswered quiz where currentTime >= trigger.timestamp
    - If quiz.required and unanswered, shouldPause = true
    - If quiz not required, user can skip (shouldPause = false after timeout)
    - Track answered quizzes in local state
    - Tolerance: trigger within 1 second of timestamp

    Edge cases:
    - Multiple quizzes at same timestamp: show one at a time
    - Seeking past quiz: trigger quiz immediately
    - Already answered: skip
  </action>
  <verify>TypeScript compiles, hook logic works in isolation</verify>
  <done>useVideoQuiz correctly identifies active quizzes based on video time</done>
</task>

<task type="auto">
  <name>Task 2: Create VideoQuizOverlay component</name>
  <files>frontend/src/components/video/VideoQuizOverlay.tsx</files>
  <action>
    Create `frontend/src/components/video/VideoQuizOverlay.tsx`:

    Props:
    - quiz: QuizQuestion (from course.ts types - reuse existing)
    - required: boolean (must answer to continue)
    - onAnswer: (answerId: string, correct: boolean) => void
    - onSkip?: () => void (only if not required)
    - onClose: () => void

    Features:
    - Full overlay on video area (semi-transparent backdrop)
    - Centered quiz card with question and options
    - Radio buttons for options (reuse patterns from QuizQuestion.tsx)
    - Submit button that validates answer
    - Show correct/incorrect feedback after answering
    - If required: no skip, must answer correctly or acknowledge wrong
    - If optional: "Skip" button available
    - After answer/skip: call onClose to resume video
    - Animation: fade in, slide up from bottom

    Styling:
    - Match existing quiz styling from ModuleQuiz.tsx
    - Dark backdrop (bg-black/70)
    - White card with rounded corners
    - Responsive: full width on mobile, max-w-lg on desktop
    - Dark mode support

    XP Integration:
    - On correct answer: emit 'quiz:answered' event via eventBus with { quizId, correct: true, source: 'video' }
    - This allows gamification to award XP for in-video quiz correctness
  </action>
  <verify>TypeScript compiles, overlay displays properly</verify>
  <done>VideoQuizOverlay shows quiz, handles answer, provides feedback</done>
</task>

<task type="auto">
  <name>Task 3: Integrate quiz system into InteractiveVideoPlayer</name>
  <files>frontend/src/components/video/InteractiveVideoPlayer.tsx, frontend/src/components/video/index.ts</files>
  <action>
    Update `InteractiveVideoPlayer.tsx` to integrate quiz functionality:

    Props update:
    - Add: quizTriggers?: VideoQuizTrigger[]
    - Add: quizzes?: Record<string, QuizQuestion> (quizId → question data)

    Integration:
    1. Use useVideoQuiz hook with currentTime and quizTriggers
    2. When activeQuiz !== null:
       - Pause video (setPlaying(false))
       - Show VideoQuizOverlay
    3. On quiz answer/skip:
       - Mark quiz as answered
       - Resume video (setPlaying(true))
       - Seek slightly forward if needed (currentTime + 0.5s)

    State management:
    - Track answeredQuizzes in component state (or videoStore)
    - Save answered quizzes to videoStore for persistence

    Update index.ts:
    - Export VideoQuizOverlay
    - Export useVideoQuiz hook
  </action>
  <verify>npm run build succeeds, quizzes trigger at correct timestamps</verify>
  <done>In-video quizzes work end-to-end: trigger → pause → answer → resume</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] No TypeScript errors
- [ ] useVideoQuiz detects quiz triggers correctly
- [ ] VideoQuizOverlay displays and accepts answers
- [ ] Required quizzes pause video and must be answered
- [ ] Optional quizzes can be skipped
- [ ] Video resumes after quiz completion
- [ ] Answered quizzes don't re-trigger on seek
- [ ] Quiz events emitted for gamification
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- In-video quizzes trigger at specified timestamps
- Video pauses for quizzes and resumes after
- Required vs optional quizzes behave differently
- XP events emitted for gamification integration
</success_criteria>

<output>
After completion, create `.planning/phases/02-interactive-content/02-03-SUMMARY.md`
</output>
